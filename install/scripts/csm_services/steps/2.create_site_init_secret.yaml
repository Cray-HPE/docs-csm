kind: step
metadata:
  name: Create Site-Init Secret
  description: |-
    # Create Site-Init Secret

    The `site-init` secret in the `loftsman` namespace makes
    `/var/www/ephemeral/prep/site-init/customizations.yaml` available to product
    installers. The `site-init` secret should only be updated when the
    corresponding `customizations.yaml` data is changed, such as during system
    installation or upgrade. Create the `site-init` secret to contain
    `/var/www/ephemeral/prep/site-init/customizations.yaml`:
spec:
  jobs:
    - preCondition:
        description: |-
          `/var/www/ephemeral/prep/site-init/customizations.yaml` exists
        command: |-
          [[ -f /var/www/ephemeral/prep/site-init/customizations.yaml ]] || exit 1
        troubleshooting: |-
          Make sure `/var/www/ephemeral/prep/site-init/customizations.yaml` exists
      action:
        description: |-
          1. Create the site-init secret to contain /var/www/ephemeral/prep/site-init/customizations.yaml
        command: |-
          kubectl delete secret -n loftsman site-init || true
          kubectl create secret -n loftsman generic site-init --from-file=/var/www/ephemeral/prep/site-init/customizations.yaml
        troubleshooting: |-
          > **`NOTE`** If the `site-init` secret already exists then `kubectl` will error
          > with a message similar to:
          >
          > ```
          > Error from server (AlreadyExists): secrets "site-init" already exists
          > ```
          >
          > In this case, delete the `site-init` secret and recreate it.
          >
          > 1. First delete it:
          >
          >    ```bash
          >    pit# kubectl delete secret -n loftsman site-init
          >    ```
          >
          >    Expected output looks similar to the following:
          >
          >    ```
          >    secret "site-init" deleted
          >    ```
          >
          > 2. Then recreate it:
          >
          >    ```bash
          >    pit# kubectl create secret -n loftsman generic site-init --from-file=/var/www/ephemeral/prep/site-init/customizations.yaml
          >    ```
          >
          >    Expected output looks similar to the following:
          >
          >    ```
          >    secret/site-init created
          >    ```

          > **`WARNING`** If for some reason the system customizations need to be
          > modified to complete product installation, administrators must first update
          > `customizations.yaml` in the `site-init` Git repository, which may no longer
          > be mounted on any cluster node, and then delete and recreate the `site-init`
          > secret as shown below.
          >
          > To **read** `customizations.yaml` from the `site-init` secret:
          >
          > ```bash
          > ncn# kubectl get secrets -n loftsman site-init -o jsonpath='{.data.customizations\.yaml}' | base64 -d > customizations.yaml
          > ```
          >
          > To **delete** the `site-init` secret:
          >
          > ```bash
          > ncn# kubectl -n loftsman delete secret site-init
          > ```
          >
          > To **recreate** the `site-init` secret:
          >
          > ```bash
          > ncn# kubectl create secret -n loftsman generic site-init --from-file=customizations.yaml
          > ```
      postValidation:
        description: |-
          Verify "site-init" secret is created
        command: |-
          kubectl get secret -A | grep site-init
        troubleshooting: |-
          # TODO: link to doc