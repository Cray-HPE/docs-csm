kind: step
metadata:
  name: Initialize Bootstrap Registry
  description: |-
    # Initialize Bootstrap Registry

    > **`NOTE`** The bootstrap registry runs in a default Nexus configuration,
    > which is started and populated in this section. It only exists during initial
    > CSM install on the PIT node in order to bootstrap CSM services. Once CSM
    > install is completed and the PIT node is rebooted as an NCN, the bootstrap
    > Nexus no longer exists.
spec:
  jobs:
    - preCondition:
        description: |-
          1.  Verify that Nexus is running:
          2.  Verify that Nexus is _ready_. (Any HTTP response other than `200 OK`
          indicates Nexus is not ready.)
        command: |-
          systemctl is-active --quiet nexus && echo Nexus is running
          nexus_writable=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8081/service/rest/v1/status/writable)
          echo "Nexus writable endpoint returns: $nexus_writable"
          [[ $nexus_writable -eq 200 ]] || exit 1
        
        troubleshooting: |-
          # Restart nexus service
          `pit# systemctl start nexus`
      action:
        description: |-
          3.  Load the skopeo image installed by the cray-nexus RPM
          4.  Use `skopeo sync` to upload container images from the CSM release
          
          > **`NOTE`** As the bootstrap Nexus uses the default configuration, the
          > above command uses the default admin credentials (`admin` user with
          > password `admin123`) in order to upload to the bootstrap registry, which
          > is listening on localhost:5000.
        command: |-
          podman load -i /var/lib/cray/container-images/cray-nexus/skopeo-stable.tar quay.io/skopeo/stable
          
          for source_dir in $(ls /var/www/ephemeral/{{ getEnv "CSM_RELEASE" }}/docker); do \
          podman run --rm --network host -v /var/www/ephemeral/{{ getEnv "CSM_RELEASE" }}/docker/${source_dir}:/images:ro quay.io/skopeo/stable sync \
          --scoped --src dir --dest docker --dest-tls-verify=false --dest-creds admin:admin123 /images localhost:5000; done
        troubleshooting: |-
          Nothing
      postValidation:
        description: |-
          >Note: there is nothing to validate
        command: 'echo "Skip Post Validation"'
        troubleshooting: |-
          # Skipped