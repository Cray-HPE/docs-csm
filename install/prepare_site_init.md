# Prepare `Site Init`

These procedures guide administrators through setting up the `site-init`
directory which contains important customizations for various products.

**Note:** There are two media available to bootstrap the PIT node: the RemoteISO or a bootable USB device. Both of those can use this procedure.
The only difference in this procedure is that the RemoteISO method will execute these commands on the PIT node, while the USB method could be done
on any Linux system. This procedure works for both methods, so in order to be generic, this document uses the command prompt of `linux#` in its
examples.

1. [Background](#background)
1. [Create and Initialize `site-init` Directory](#create-and-initialize-site-init-directory)
1. [Create Baseline System Customizations](#create-baseline-system-customizations)
1. [Generate Sealed Secrets](#generate-sealed-secrets)
1. [Version Control `Site Init` Files](#version-control-site-init-files)
    1. [Push to a Remote Repository](#push-to-a-remote-repository)
1. [Customer-Specific Customizations](#customer-specific-customizations)

## Prerequisites

The procedures on this page assumes that the `SYSTEM_NAME`, `CSM_RELEASE`, `CSM_PATH`, and `PITDATA` variables are
set and exported. This is normally done as part of the [Bootstrap PIT Node](index.md#bootstrap_pit_node) procedure.

```bash
linux# echo -e "CSM_PATH=${CSM_PATH}\nCSM_RELEASE=${CSM_RELEASE}\nPITDATA=${PITDATA}\nSYSTEM_NAME=${SYSTEM_NAME}"
```
Expected Output -
```text
CSM_PATH=/root/usb/csm-1.2.0
CSM_RELEASE=csm-1.2.0
PITDATA=/mnt/pitdata
SYSTEM_NAME=gamora
``` 

<a name="background"></a>

## 1. Background

The `shasta-cfg` directory included in the CSM release tarball includes relatively static,
installation-centric artifacts, such as:

* Cluster-wide network configuration settings required by Helm Charts deployed by product stream Loftsman Manifests
* [Sealed Secrets](https://github.com/bitnami-labs/sealed-secrets)
* Sealed Secret Generate Blocks -- a form of plain-text input that renders to a Sealed Secret
* Helm Chart value overrides that are merged into Loftsman Manifests by product stream installers

<a name="create-and-initialize-site-init-directory"></a>

## 2. Create and Initialize `site-init` Directory

1. Set the `SITE_INIT` variable.

    > **Important:** All procedures on this page assume that this variable has been set.

    ```bash
    linux# SITE_INIT=${PITDATA}/prep/site-init
    ```

1. Create the `site-init` directory.

    ```bash
    linux# mkdir -pv ${SITE_INIT} && pushd ${SITE_INIT}
    ```
    Expected Output - 
    ```text
    mkdir: created directory '/mnt/pitdata/prep/site-init'
    /mnt/pitdata/prep/site-init /mnt/pitdata/prep/gamora

    ```
1. Initialize `site-init` from CSM.

    ```bash
    linux# ${CSM_PATH}/shasta-cfg/meta/init.sh ${SITE_INIT}
    ```
    Expected Output -
    ```text
    Source Directory is: /root/usb/csm-1.2.0/shasta-cfg
    Target Directory is: /mnt/pitdata/prep/site-init
    Copying docs...
    Copying scripts/utils...
    Migrating customizations...
    Creating sealed secret key-pair if needed...
    Generating a RSA private key
    .............................++++
    .++++
    writing new private key to '/mnt/pitdata/prep/site-init/certs/sealed_secrets.key'
    -----
    Creating git repo at target (if not already a repo)
    Initializing git repository in /mnt/pitdata/prep/site-init
    hint: Using 'master' as the name for the initial branch. This default branch name
    hint: is subject to change. To configure the initial branch name to use in all
    hint: of your new repositories, which will suppress this warning, call:
    hint:
    hint:   git config --global init.defaultBranch <name>
    hint:
    hint: Names commonly chosen instead of 'master' are 'main', 'trunk' and
    hint: 'development'. The just-created branch can be renamed via this command:
    hint:
    hint:   git branch -m <name>
    Initialized empty Git repository in /mnt/pitdata/prep/site-init/.git/

    **** IMPORTANT: Review and update /mnt/pitdata/prep/site-init/customizations.yaml and introduce custom edits (if applicable). ****
    ```

1. Set an alias to the `yq` tool for use in these procedures.

    1. Set the alias.

        ```bash
        linux# alias yq="${CSM_PATH}/shasta-cfg/utils/bin/$(uname | awk '{print tolower($0)}')/yq"
        ```

    1. Confirm that the alias points to the `yq` command.

        ```bash
        linux# yq -V
        ```

        Expected output looks similar to the following (although the version number may vary):

        ```text
        yq version 3.3.0
        ```

<a name="create-baseline-system-customizations"></a>

### 3. Create Baseline System Customizations

The following steps update `${SITE_INIT}/customizations.yaml`
with system-specific customizations.

1. Merge the system-specific settings generated by CSI into
    `customizations.yaml`.

    ```bash
    linux# yq merge -xP -i ${SITE_INIT}/customizations.yaml <(yq prefix -P "${PITDATA}/prep/${SYSTEM_NAME}/customizations.yaml" spec)
    ```

1. Set the cluster name.

    ```bash
    linux# yq write -i ${SITE_INIT}/customizations.yaml spec.wlm.cluster_name "${SYSTEM_NAME}"
    ```

1. Make a backup copy of `${SITE_INIT}/customizations.yaml`.

    ```bash
    linux# cp -v ${SITE_INIT}/customizations.yaml ${SITE_INIT}/customizations.yaml.prepassword
    ```

1. Review the configuration to generate these sealed secrets in `customizations.yaml` in the `site-init` directory.

    * `spec.kubernetes.sealed_secrets.cray_reds_credentials`
    * `spec.kubernetes.sealed_secrets.cray_meds_credentials`
    * `spec.kubernetes.sealed_secrets.cray_hms_rts_credentials`

    The `cray_reds_credentials` are used by the HMS Discovery CronJob and the River Endpoint Discovery Service (REDS) for River components. This sealed secret contains the following:
      * Default Redfish `root` user credentials for air-cooled Node and Router BMCs.
      * Default SNMP credentials configured on `leaf-bmc` switches. This needs to match the SNMP credentials currently configured on `leaf-bmc` switches or the credentials will be configured later in the install. The SNMP username, authentication password,
        and the privacy password need to be provided.

    The `cray_meds_credentials` are used by the Mountain Endpoint Discovery Service (MEDS) for the liquid-cooled components in an Olympus (Mountain) cabinet.
      * The `root` user password needs to match what is currently configured on the CECs for the liquid-cooled cabinets in the system.

    The `cray_hms_rts_credentials` are used by the Redfish Translation Service (RTS) for any hardware components which are not managed by Redfish, such as a ServerTech PDU in a River Cabinet.
      * The ServerTech PDU credentials need to match the credentials for the `admn` user that is currently configured on the PDUs.
      * The RTS `root` user credentials are unique to RTS and used only within the service mesh; these can be set as desired.

    Edit `customizations.yaml` to replace the `Username` and `Password` references in the file so that the values match the **existing settings** of your system hardware components.
    See the `Decrypt Sealed Secrets for Review` section of [Manage Sealed Secrets](../operations/security_and_authentication/Manage_Sealed_Secrets.md#decrypt-sealed-secrets-for-review)
    if needing to examine credentials from prior installs.

    ```bash
    linux# vi ${SITE_INIT}/customizations.yaml
    ```

1. Review the changes that you made.

    ```bash
    linux# diff ${SITE_INIT}/customizations.yaml ${SITE_INIT}/customizations.yaml.prepassword
    ```
    ![alt text](siteinit1.png)
    ![alt text](siteinit2.png)
    ![alt text](siteinit3.png)
    <snip>
    
    

1. Validate that REDS/MEDS/RTS credentials.

    For all credentials, Make sure `Username` and `Password` values are correct.

    1. Validate REDS credentials.

        These credentials are used by the REDS and HMS discovery services, targeting River Redfish
        BMC endpoints and management switches

        > NOTE: For `vault_redfish_defaults`, the only entry used is `'{"Cray": {"Username": "root", "Password": "XXXX"}'`
        > Make sure it is specified as shown, with the `Cray` key. This key is not used in any of the other credential specifications.

        ```bash
        linux# yq read ${SITE_INIT}/customizations.yaml 'spec.kubernetes.sealed_secrets.cray_reds_credentials.generate.data[*].args.value' | jq
        ```
        Expected Output-
        ```text
        <snip>
        {
         "Cray": {
         "Username": "root",
         "Password": "initial0"
          }
        }
        {
         "SNMPUsername": "testuser",
         "SNMPAuthPassword": "testpass1",
         "SNMPPrivPassword": "testpass2"
        }
        <snip>
        ```

    1. Validate MEDS credentials.

        These credentials are used by the MEDS service, targeting Redfish BMC endpoints.

        ```bash
        linux# yq read ${SITE_INIT}/customizations.yaml 'spec.kubernetes.sealed_secrets.cray_meds_credentials.generate.data[0].args.value' | jq
        ```
        Extected Output - 
        ```text
        <snip>
        {
         "Username": "root",
         "Password": "initial0"
        }
        <snip>
        ```


    1. Validate RTS credentials.

        These credentials are used by the Redfish Translation Service, targeting River Redfish BMC endpoints and PDU controllers.

        ```bash
        linux# yq read ${SITE_INIT}/customizations.yaml 'spec.kubernetes.sealed_secrets.cray_hms_rts_credentials.generate.data[*].args.value' | jq
        ```
        Expected Output - 
        ```text
        <snip>
        {
          "Username": "admn",
          "Password": "admn"
        }
        {
          "Username": "root",
          "Password": "initial0"
        }
        <snip>
        ```

1. To customize the PKI Certificate Authority (CA) used by the platform, see
    [Certificate Authority](../background/certificate_authority.md).

    > **`IMPORTANT`** The CA may not be modified after install.

1. Federate Keycloak with an upstream LDAP server.

    1. Set environment variables for the LDAP server and its port.

       In the example below, the LDAP server has the hostname `dcldap2.us.cray.com` and is using the port 636.

       ```bash
       linux# LDAP=dcldap3.us.cray.com
       linux# PORT=636
       ```
       NOTE: if system's IP address is even use dcldap2 else use dcldap3 


    1. Update the `cray-keycloak` sealed secret value if LDAP requires TLS.

        If LDAP requires TLS (recommended), then update the `cray-keycloak` sealed
        secret value by supplying a base64-encoded Java KeyStore (JKS) that
        contains the CA certificate that signed the LDAP server's host key. The
        password for the JKS file must be `password`. Administrators may use the
        `keytool` command from the `openjdk:11-jre-slim` container image
        packaged with CSM to create a JKS file that includes a PEM-encoded
        CA certificate to verify the LDAP host(s) as follows:

        This step builds an example that will create (or update) `cert.jks` with the PEM-encoded CA certificate for an LDAP host, and then
        prepares `certs.jks.b64`, which will be injected into `customizations.yaml`.

        1. Load the `openjdk` container image.

           > **`NOTE`** Requires a properly configured Docker or Podman
           > environment.

           ```bash
           linux# ${CSM_PATH}/hack/load-container-image.sh artifactory.algol60.net/csm-docker/stable/docker.io/library/openjdk:11-jre-slim
           ```
           Expected Output:
           ```text
           + command -v podman
            + for conf in graphRoot graphDriverName runRoot
            ++ echo graphRoot
            ++ tr '[:upper:]' '[:lower:]'
            + conf_lc=graphroot
            ++ podman info -f json
            ++ jq -r .store.graphRoot
            WARN[0000] Error validating CNI config file /etc/cni/net.d/00-multus.conf   : [failed to find plugin "multus" in path [/usr/lib/cni]]
            + conf_val=/var/lib/containers/storage
            + '[' /var/lib/containers/storage == null ']'
            + declare graphroot=/var/lib/containers/storage
            + for conf in graphRoot graphDriverName runRoot
            <snip>
            + podman run --rm --network none --privileged --ulimit=host -v /var/lib/containers/storage:/var/lib/containers/storage -v /root/usb/csm-1.2.0/docker:/image:ro docker.io/library/skopeo:csm-1.2.0 copy dir:/image/artifactory.algol60.net/csm-docker/stable/docker.io/library/openjdk:11-jre-slim containers-storage:artifactory.algol60.net/csmdocker/stable/docker.io/libr ary/openjdk:11-jre-slim
            WARN[0000] Error validating CNI config file /etc/cni/net.d/00-multus.conf : [failed to find plugin "multus" in path [/usr/lib/cni]]
            WARN[0000] Path "/etc/zypp/credentials.d/SCCcredentials" from "/etc/containers/mounts.conf" doesn't exist, skipping
            Getting image source signatures
            Copying blob sha256:d7bfe07ed8476565a440c2113cc64d7c0409dba8ef761fb3ec019d7e6b5952df
            Copying blob sha256:ca882cef2bfe794b77617b50cb057523fa9822db75a6a3f8e69690c0da62182b
            Copying blob sha256:8e3ea981993cebcb2cd41d79f593d8ec307e3faa3523f1f8698ef0d7fe125f1d
            Copying blob sha256:4cbe6bf389345e3e77b72954b0280d2fecdf7ec0093a6d8bec5c3d4ea62afcc0
            Copying blob sha256:91cb1de271d6f5c8881bddc559d9bf8f9827e0848bc62ef5451a4ac744ac23ae
            Copying config sha256:6e6be590b0c104e58b4e95a37663045d90aa09f2d52cbc62f6ba09f47246722b
            Writing manifest to image destination
            Storing signatures

           ```
           

        1. Get the issuer certificate.

            Retrieve the issuer certificate for the LDAP server at port 636. Use `openssl s_client` to connect
            and show the certificate chain returned by the LDAP host:

            ```bash
            linux# openssl s_client -showcerts -connect ${LDAP}:${PORT} </dev/null
            ```
            Expected Output - 
            ```bash
            CONNECTED(00000003)
            depth=1 C = US, ST = WI, O = HPE, OU = HPC/MCS, CN = Data Center, emailAddress = dcops@hpe.com
            verify error:num=19:self signed certificate in certificate chain
            verify return:1
            depth=1 C = US, ST = WI, O = HPE, OU = HPC/MCS, CN = Data Center, emailAddress = dcops@hpe.com
            verify return:1
            depth=0 C = US, ST = WI, L = Chippewa Falls, O = HPE, OU = HPC/MCS, CN = dcldap3.us.cray.com, emailAddress = dcops@hpe.com
            verify return:1
            ---
            Certificate chain
            0 s:C = US, ST = WI, L = Chippewa Falls, O = HPE, OU = HPC/MCS, CN = dcldap3.us.cray.com, emailAddress = dcops@hpe.com
               i:C = US, ST = WI, O = HPE, OU = HPC/MCS, CN = Data Center, emailAddress = dcops@hpe.com
            -----BEGIN CERTIFICATE-----
            MIIEBzCCAu+gAwIBAgIUYxrG/PrMcmIzDuJ+U1Gh8hpsU9owDQYJKoZIhvcNAQEL
            <snip>
            LHdSHZhZtCuExCF3bCO+zJkvA6S1tazzYpEq
            -----END CERTIFICATE-----
            1 s:C = US, ST = WI, O = HPE, OU = HPC/MCS, CN = Data Center, emailAddress = dcops@hpe.com
               i:C = US, ST = WI, O = HPE, OU = HPC/MCS, CN = Data Center, emailAddress = dcops@hpe.com
            -----BEGIN CERTIFICATE-----
            <snip>
            NA==
            -----END CERTIFICATE--------
            Server certificate
            subject=C = US, ST = WI, L = Chippewa Falls, O = HPE, OU = HPC/MCS, CN = dcldap3.us.cray.com, emailAddress = dcops@hpe.com

            issuer=C = US, ST = WI, O = HPE, OU = HPC/MCS, CN = Data Center, emailAddress = dcops@hpe.com

            ---
            No client certificate CA names sent
            Peer signing digest: SHA256
            Peer signature type: RSA-PSS
            Server Temp Key: X25519, 253 bits
            ---
            SSL handshake has read 2557 bytes and written 401 bytes
            Verification error: self signed certificate in certificate chain
            ---
            New, TLSv1.3, Cipher is TLS_AES_256_GCM_SHA384
            Server public key is 2048 bit
            Secure Renegotiation IS NOT supported
            Compression: NONE
            Expansion: NONE
            No ALPN negotiated
            Early data was not sent
            Verify return code: 19 (self signed certificate in certificate chain)
            ---
            DONE
            ```

        1. Enter the issuer's certificate into `cacert.pem`.

            Either manually extract (i.e., cut/paste) the issuer's
            certificate into `cacert.pem`, or try the following commands to
            create it automatically.

            > **`NOTE`** The following commands were verified using OpenSSL
            > version 1.1.1d and use the `-nameopt RFC2253` option to ensure
            > consistent formatting of distinguished names (DNs).
            > Unfortunately, older versions of OpenSSL may not support
            > `-nameopt` on the `s_client` command or may use a different
            > default format. As a result, your mileage may vary; however,
            > you should be able to extract the issuer certificate manually
            > from the output of the above `openssl s_client` example if the
            > following commands are unsuccessful.

            1. Observe the issuer's DN.

                ```bash
                linux# openssl s_client -showcerts -nameopt RFC2253 -connect ${LDAP}:${PORT} </dev/null 2>/dev/null | grep issuer= | sed -e 's/^issuer=//'
                ```

                Expected output includes a line similar to this:

                ```text
                emailAddress=dcops@hpe.com,CN=Data Center,OU=HPC/MCS,O=HPE,ST=WI,C=US
                ```

            1. Extract the issuer's certificate using `awk`.

                > **`NOTE`** The issuer DN is properly escaped as part of the
                > `awk` pattern below. It must be changed to match the value
                > for `emailAddress`, `CN`, `OU`, etc. for your LDAP. If the value
                > you are using is different, be sure to escape it properly!

                ```bash
                linux# openssl s_client -showcerts -nameopt RFC2253 -connect ${LDAP}:${PORT} </dev/null 2>/dev/null |
                          awk '/s:emailAddress=dcops@hpe.com,CN=Data Center,OU=HPC\/MCS,O=HPE,ST=WI,C=US/,/END CERTIFICATE/' |
                          awk '/BEGIN CERTIFICATE/,/END CERTIFICATE/' > cacert.pem
                ```

        1. Verify that the issuer's certificate was properly extracted and saved in `cacert.pem`.

            ```bash
            linux# cat cacert.pem
            ```

            Expected output looks like:

            ```text
            -----BEGIN CERTIFICATE-----
            MIIDvTCCAqWgAwIBAgIUYxrG/PrMcmIzDuJ+U1Gh8hpsU8cwDQYJKoZIhvcNAQEL
            BQAwbjELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAldJMQwwCgYDVQQKDANIUEUxEDAO
            BgNVBAsMB0hQQy9NQ1MxFDASBgNVBAMMC0RhdGEgQ2VudGVyMRwwGgYJKoZIhvcN
            AQkBFg1kY29wc0BocGUuY29tMB4XDTIwMTEyNDIwMzM0MVoXDTMwMTEyMjIwMzM0
            MVowbjELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAldJMQwwCgYDVQQKDANIUEUxEDAO
            BgNVBAsMB0hQQy9NQ1MxFDASBgNVBAMMC0RhdGEgQ2VudGVyMRwwGgYJKoZIhvcN
            AQkBFg1kY29wc0BocGUuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKC
            AQEAuBIZkKitHHVQHymtaQt4D8ZhG4qNJ0cTsLhODPMtVtBjPZp59e+PWzbc9Rj5
            +wfjLGteK6/fNJsJctWlS/ar4jw/xBIPMk5pg0dnkMT2s7lkSCmyd9Uib7u6y6E8
            yeGoGcb7I+4ZI+E3FQV7zPact6b17xmajNyKrzhBGEjYucYJUL5iTgZ6a7HOZU2O
            aQSXe7ctiHBxe7p7RhHCuKRrqJnxoohakloKwgHHzDLFQzX/5ADp1hdJcduWpaXY
            RMBu6b1mhmwo5vmc+fDnfUpl5/X4i109r9VN7JC7DQ5+JX8u9SHDGLggBWkrhpvl
            bNXMVCnwnSFfb/rnmGO7rdJSpwIDAQABo1MwUTAdBgNVHQ4EFgQUVg3VYExUAdn2
            WE3e8Xc8HONy/+4wHwYDVR0jBBgwFoAUVg3VYExUAdn2WE3e8Xc8HONy/+4wDwYD
            VR0TAQH/BAUwAwEB/zANBgkqhkiG9w0BAQsFAAOCAQEAWLDQLB6rrmK+gwUY+4B7
            0USbQK0JkLWuc0tCfjTxNQTzFb75PeH+GH21QsjUI8VC6QOAAJ4uzIEV85VpOQPp
            qjz+LI/Ej1xXfz5ostZQu9rCMnPtVu7JT0B+NV7HvgqidTfa2M2dw9yUYS2surZO
            8S0Dq3Bi6IEhtGU3T8ZpbAmAp+nNsaJWdUNjD4ECO5rAkyA/Vu+WyMz6F3ZDBmRr
            ipWM1B16vx8rSpQpygY+FNX4e1RqslKhoyuzXfUGzyXux5yhs/ufOaqORCw3rJIx
            v4sTWGsSBLXDsFM3lBgljSAHfmDuKdO+Qv7EqGzCRMpgSciZihnbQoRrPZkOHUxr
            NA==
            -----END CERTIFICATE-----
            ```

        1. Create `certs.jks`.

            > **`NOTE`** The alias used in this command for `cray-data-center-ca` should be changed to match your LDAP.

            ```bash
            linux# podman run --rm -v "$(pwd):/data" \
                    artifactory.algol60.net/csm-docker/stable/docker.io/library/openjdk:11-jre-slim keytool \
                    -importcert -trustcacerts -file /data/cacert.pem -alias cray-data-center-ca \
                    -keystore /data/certs.jks -storepass password -noprompt
            ```
            Exected Output - 
            ```text
            WARN[0000] Error validating CNI config file /etc/cni/net.d/00-multus.conf                                                                                : [failed to find plugin "multus" in path [/usr/lib/cni]]
            WARN[0000] Path "/etc/zypp/credentials.d/SCCcredentials" from "/etc/containers/mounts.conf" doesn't exist, skipping

            Certificate was added to keystore

            ```
        1. Create `certs.jks.b64` by base64 encoding `certs.jks`.

            ```bash
            linux# base64 certs.jks > certs.jks.b64
            ```

        1. Inject and encrypt `certs.jks.b64` into `customizations.yaml`.

            ```bash
            linux# cat <<EOF | yq w - 'data."certs.jks"' "$(<certs.jks.b64)" | \
                yq r -j - | ${SITE_INIT}/utils/secrets-encrypt.sh | \
                yq w -f - -i ${SITE_INIT}/customizations.yaml 'spec.kubernetes.sealed_secrets.cray-keycloak'
            {
              "kind": "Secret",
              "apiVersion": "v1",
              "metadata": {
                "name": "keycloak-certs",
                "namespace": "services",
                "creationTimestamp": null
              },
              "data": {}
            }
            EOF
            ```

    1. Update the `keycloak_users_localize` sealed secret with the
        appropriate value for `ldap_connection_url`.

        1. Set `ldap_connection_url` in `customizations.yaml`.

           For example:

           ```bash
           linux# yq write -i ${SITE_INIT}/customizations.yaml \
                    'spec.kubernetes.sealed_secrets.keycloak_users_localize.generate.data.(args.name==ldap_connection_url).args.value' \
                    "ldaps://${LDAP}"
           ```

        1. On success, review the `keycloak_users_localize` sealed secret.

           ```bash
           linux# yq read ${SITE_INIT}/customizations.yaml spec.kubernetes.sealed_secrets.keycloak_users_localize
           ```

           Expected output is similar to:

           ```yaml
           generate:
               name: keycloak-users-localize
               data:
               - type: static
                   args:
                   name: ldap_connection_url
                   value: ldaps://dcldap3.us.cray.com
           ```

    1. Configure the `ldapSearchBase` and `localRoleAssignments` settings for
        the `cray-keycloak-users-localize` chart in `customizations.yaml`.

        There may be one or more groups in LDAP for administrators and one or more for users.
        Each admin group needs to be assigned to role `admin` and set to both `shasta` and `cray` clients in Keycloak.
        Each user group needs to be assigned to role `user` and set to both `shasta` and `cray` clients in Keycloak.

        1. Set `ldapSearchBase` in `customizations.yaml`.

           This example sets `ldapSearchBase` to `dc=dcldap,dc=dit`

           ```bash
           linux# yq write -i ${SITE_INIT}/customizations.yaml spec.kubernetes.services.cray-keycloak-users-localize.ldapSearchBase 'dc=dcldap,dc=dit'
           ```

        1. Set `localRoleAssignments` in `customizations.yaml`.

           This example sets `localRoleAssignments` for the LDAP groups `employee`, `craydev`, and `shasta_admins` to be the admin role and the LDAP group `shasta_users` to be the user role.

           ```bash
           linux# yq write -s - -i ${SITE_INIT}/customizations.yaml <<EOF
           - command: update
             path: spec.kubernetes.services.cray-keycloak-users-localize.localRoleAssignments
             value:
             - {"group": "employee", "role": "admin", "client": "shasta"}
             - {"group": "employee", "role": "admin", "client": "cray"}
             - {"group": "craydev", "role": "admin", "client": "shasta"}
             - {"group": "craydev", "role": "admin", "client": "cray"}
             - {"group": "shasta_admins", "role": "admin", "client": "shasta"}
             - {"group": "shasta_admins", "role": "admin", "client": "cray"}
             - {"group": "shasta_users", "role": "user", "client": "shasta"}
             - {"group": "shasta_users", "role": "user", "client": "cray"}
           EOF
           ```

        1. On success, review the `cray-keycloak-users-localize` values.

           ```bash
           linux# yq read ${SITE_INIT}/customizations.yaml spec.kubernetes.services.cray-keycloak-users-localize
           ```

           Expected output looks similar to:

           ```yaml
           sealedSecrets:
               - '{{ kubernetes.sealed_secrets.keycloak_users_localize | toYaml }}'
           localRoleAssignments:
               - {"group": "employee", "role": "admin", "client": "shasta"}
               - {"group": "employee", "role": "admin", "client": "cray"}
               - {"group": "craydev", "role": "admin", "client": "shasta"}
               - {"group": "craydev", "role": "admin", "client": "cray"}
               - {"group": "shasta_admins", "role": "admin", "client": "shasta"}
               - {"group": "shasta_admins", "role": "admin", "client": "cray"}
               - {"group": "shasta_users", "role": "user", "client": "shasta"}
               - {"group": "shasta_users", "role": "user", "client": "cray"}
           ldapSearchBase: dc=dcldap,dc=dit
           ```

1. <s>Configure the Unbound DNS resolver (if needed).

    **Important:** If access to a site DNS server is required **and** this DNS server was specified to `csi` using the `site-dns` option (either on the command line or in the `system_config.yaml` file),
    **then no further action is required and this step should be skipped**.

    The default configuration is as follows:

    ```yaml
    cray-dns-unbound:
        domain_name: '{{ network.dns.external }}'
        forwardZones:
          - name: "."
            forwardIps:
              - "{{ network.netstaticips.system_to_site_lookups }}"
    ```

    The configured site DNS server can be verified by inspecting the value set for `system_to_site_lookups`.

    ```bash
    linux# yq r ${SITE_INIT}/customizations.yaml spec.network.netstaticips.system_to_site_lookups
    172.30.84.40
    ```

    If there is **no requirement to resolve external hostnames or no upstream DNS server**,
    then remove the DNS forwarding configuration from the `cray-dns-unbound` service.

    1. Remove the `forwardZones` configuration for the `cray-dns-unbound` service.

        ```bash
        linux# yq delete -i ${SITE_INIT}/customizations.yaml spec.kubernetes.services.cray-dns-unbound.forwardZones
        ```

    1. Review the `cray-dns-unbound` values.

        ```bash
        linux# yq read ${SITE_INIT}/customizations.yaml spec.kubernetes.services.cray-dns-unbound
        ```

        Expected output is:

        ```yaml
        domain_name: '{{ network.dns.external }}'
        ```

        > **`IMPORTANT`** **Do not** remove the `domain_name` entry, it is required for Unbound to forward requests to PowerDNS correctly.</s>

1. <s>(Optional) Configure PowerDNS zone transfer and DNSSEC.

   * If zone transfer is to be configured review `customizations.yaml` and ensure the `primary_server`, `secondary_servers`, and `notify_zones` values are set correctly.

   * If DNSSEC is to be used then add the desired keys into the `dnssec` SealedSecret.

   See the [PowerDNS Configuration Guide](../operations/network/dns/PowerDNS_Configuration.md) for more information.</s>

   <a name="configure-prometheus-snmp-exporter"></a>

1. <s>(Optional) Configure Prometheus SNMP Exporter.

   The Prometheus SNMP exporter needs to be configured with a list of management network switches to scrape metrics from in
   order to populate the System Health Service Grafana dashboards.

   See [Prometheus SNMP Exporter](../operations/network/management_network/snmp_exporter_configs.md) for more information.</s>

<a name="generate-sealed-secrets"></a>

## 4. Generate Sealed Secrets

Secrets are stored in `customizations.yaml` as `SealedSecret` resources (that is,
encrypted secrets) which are deployed by specific charts and decrypted by the
Sealed Secrets operator. But first, those secrets must be seeded generated and
encrypted.

1. Load the `zeromq` container image required by Sealed Secret Generators.

    > **`NOTE`** Requires a properly configured Docker or Podman environment.

    ```bash
    linux# ${CSM_PATH}/hack/load-container-image.sh artifactory.algol60.net/csm-docker/stable/docker.io/zeromq/zeromq:v4.0.5
    ```
    Expected Output-
    ```text
    /docker.io/zeromq/zeromq:v4.0.5
        + command -v podman
        + for conf in graphRoot graphDriverName runRoot
        ++ echo graphRoot
        ++ tr '[:upper:]' '[:lower:]'
        + conf_lc=graphroot
        ++ podman info -f json
        ++ jq -r .store.graphRoot
        WARN[0000] Error validating CNI config file /etc/cni/net.d/00-multus.conf: [failed to find plugin "multus" in path [/usr/lib/cni]]
        + conf_val=/var/lib/containers/storage
        + '[' /var/lib/containers/storage == null ']'
        + declare graphroot=/var/lib/containers/storage
        + for conf in graphRoot graphDriverName runRoot
        ++ echo graphDriverName
        ++ tr '[:upper:]' '[:lower:]'
        + conf_lc=graphdrivername
        ++ podman info -f json
        ++ jq -r .store.graphDriverName
        WARN[0000] Error validating CNI config file /etc/cni/net.d/00-multus.conf: [failed to find plugin "multus" in path [/usr/lib/cni]]
        + conf_val=overlay
        <………….snip……………..>


        WARN[0000] Error validating CNI config file /etc/cni/net.d/00-multus.conf: [failed to find plugin "multus" in path [/usr/lib/cni]]
        WARN[0000] Path "/etc/zypp/credentials.d/SCCcredentials" from "/etc/containers/mounts.conf" doesn't exist, skipping
        Getting image source signatures
        Copying blob sha256:d7bfe07ed8476565a440c2113cc64d7c0409dba8ef761fb3ec019d7e6b5952df
        Copying blob sha256:cfcdf321d776e1b4ab82fe5e954d0e401a4fff42601f62f4041f858fd1ea71b5
        Copying blob sha256:8dc2d8c3c5111994f128f0bcf24b56c312377eb3a5ed27410ebe0a9d95dd94ad
        Copying blob sha256:358ce8021a9af29076af812381b717d97e5fe4afeee2c5448bc4dc60b403e202
        Copying blob sha256:a35579dbc4b84339735e78f5d225f1f82c47319f43881e51083fb092a0c91567
        Copying config sha256:8199c43b70659724411b10f6e431125a36d862e97c842c1ca098cdb02934a346
        Writing manifest to image destination
        Storing signatures

    ```

1. Re-encrypt existing secrets.

    ```bash
    linux# ${SITE_INIT}/utils/secrets-reencrypt.sh ${SITE_INIT}/customizations.yaml \
                ${SITE_INIT}/certs/sealed_secrets.key ${SITE_INIT}/certs/sealed_secrets.crt
    ```

1. Generate secrets.

    ```bash
    linux# ${SITE_INIT}/utils/secrets-seed-customizations.sh ${SITE_INIT}/customizations.yaml
    ```

    Expected output looks similar to:

    ```text
    Creating Sealed Secret keycloak-certs
    Generating type static_b64...
    Creating Sealed Secret keycloak-master-admin-auth
    Generating type static...
    Generating type static...
    Generating type randstr...
    Generating type static...
    Creating Sealed Secret cray_reds_credentials
    Generating type static...
    Generating type static...
    Creating Sealed Secret cray_meds_credentials
    Generating type static...
    Creating Sealed Secret cray_hms_rts_credentials
    Generating type static...
    Generating type static...
    Creating Sealed Secret vcs-user-credentials
    Generating type randstr...
    Generating type static...
    Creating Sealed Secret generated-platform-ca-1
    Generating type platform_ca...
    Creating Sealed Secret pals-config
    Generating type zmq_curve...
    Generating type zmq_curve...
    Creating Sealed Secret munge-secret
    Generating type randstr...
    Creating Sealed Secret slurmdb-secret
    Generating type static...
    Generating type static...
    Generating type randstr...
    Generating type randstr...
    Creating Sealed Secret keycloak-users-localize
    Generating type static...
    ```

<a name="version-control-site-init-files"></a>

## 5. <s>Version Control `Site Init` Files

Setup `site-init` as a Git repository in order to manage the
baseline configuration during initial system installation.

1. Initialize `site-init` as a Git repository.

    ```bash
    linux# cd ${SITE_INIT}
    linux# git init .
    ```

1. (Optional) Exclude sealed secret private keys from Git.

    **`WARNING`** If production system or operational security is a
    concern, do NOT store the sealed secret private key in Git; instead,
    **store the sealed secret key outside of Git in a secure offline system**.
    In order to ensure that these sensitive keys are not accidentally committed,
    configure `.gitignore` to ignore files under the `certs` directory:

    ```bash
    linux# echo "certs/" >> .gitignore
    ```

1. Stage `site-init` files to be committed.

    ```bash
    linux# git add -A
    ```

1. Review what will be committed.

    ```bash
    linux# git status
    ```

1. Commit the baseline configuration.

    ```bash
    linux# git commit -m "Baseline configuration for $(${CSM_PATH}/lib/version.sh)"
    ```

<a name="push-to-a-remote-repository"></a>

### 5.1 Push to a Remote Repository

It is **strongly recommended** that the `site-init` repository be maintained
off-cluster. Add a remote repository and push the baseline configuration on
`master` branch to a corresponding remote branch.

<a name="customer-specific-customizations"></a></s>

## 6. Customer-Specific Customizations

Customer-specific customizations are any changes on top of the baseline
configuration to satisfy customer-specific requirements. It is recommended that
customer-specific customizations be tracked on branches separate from the
mainline in order to make them easier to manage.

Apply any customer-specific customizations by merging the corresponding
branches into `master` branch of `site-init`.

When considering merges, and especially when resolving conflicts, carefully
examine differences to ensure all changes are relevant. For example, when
applying a customer-specific customization used in a prior version, be sure the
change still makes sense. It is common for options to change as new features are
introduced and bugs are fixed.
