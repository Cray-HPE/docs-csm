# Add NCN Data

## Description

Add NCN data to System Layout Service (SLS), Hardware Management Services (HMS) and Boot Script Service (BSS) as needed to add an NCN.

Scenarios where this procedure is applicable:
1. Adding a Management NCN that has not previously been in the system before:
   - Add an additional NCN to an existing cabinet (requires ...)
   - Add an NCN that is being replaced by another NCN of the same type and in the same slot
   - Adding a new NCN that to replace a NCN removed from the system in to a new location

2. Adding a Management NCN that has been previously present in the system before:
   - Adding an NCN that was previously removed from the system to move it to a new location

## Perquisites

* If adding a NCN that was not previously in the system follow the [Access and Update the Settings for Replacement NCNs](../Access_and_Update_the_Settings_for_Replacement_NCNs.md).

* The NCN being added is currently rack and cabled into the system.

## Procedure
1.  Collect the following information from the NCN:
    1.  Determine the xname of the NCN by referring to River Rack Layout tab of the systems SHCD if it has not been found yet.
        | Source          | Rack  | Location |     | Parent          |     | Port | Destination | Rack   | Location |     | Port |
        | --------------- | ----- | -------- | --- | --------------- | --- | ---- | ----------- | ------ | -------- | --- | ---- |
        | wn01            | x3000 | u04      | -   |                 |     | j3   | sw-smn01    | x3000  | u14      | -   | j48  |

        The Slot of the node is determined by the bottom most rack U that node occupies.
    
        Xname format: xXcCsSbBnN
        - X - cabinet = 3000
        - C - chassis = 0, for River nodes this is always 0
        - S - slot/Rack U = 38
        - B - bmc = 0, for Management NCNs this is always 0
        - N - node = 0, for Management NCNs this is always 0 

    2.  Determine the xname of the MgmtSwitchConnector (switch port of the management switch the BMC is connected to). This is not required for ncn-m001, as its BMC is typically connected to the site network.
        | Source          | Rack  | Location |     | Parent          |     | Port | Destination | Rack   | Location |     | Port |
        | --------------- | ----- | -------- | --- | --------------- | --- | ---- | ----------- | ------ | -------- | --- | ---- |
        | wn01            | x3000 | u04      | -   |                 |     | j3   | sw-smn01    | x3000  | u14      | -   | j48  |

        TODO: add wording for the destination columns 

        Xname format: xXcCwWjJ
        - X - cabinet = 3000
        - C - Chassis = 0, for River nodes this is always 0
        - W - slot = 22 
        - J - Switch port = 40

    3.  Collect NCN MAC Addresses for the following interfaces if they are present. Depending on the hardware present not all of the following interfaces will be present.
        1. mgmt0
        2. mgmt1
        3. mgmt2
        4. mgmt3
        5. hsn0
        6. hsn1
        7. lan0
        8. lan1

        - **If the NCN added was previously in the system**, then these MAC addresses can be retrieved backup files generated by the [Remove NCN Data](Remove_NCN_Data.md) procedure.

        ```bash
        ncn-m# cat /tmp/remove_management_ncn/$XNAME/bss-bootparameters-$XNAME.json | jq .[].params -r | tr " " "\n" | grep ifname
        ```

        Sample output:
        ```
        ifname=hsn0:50:6b:4b:23:9f:7c
        ifname=lan1:b8:59:9f:d9:9d:e9
        ifname=lan0:b8:59:9f:d9:9d:e8
        ifname=mgmt0:a4:bf:01:65:6a:aa
        ifname=mgmt1:a4:bf:01:65:6a:ab
        ```

        | Interface | MAC Address         | CLI Flag
        | --------- | ------------------- | -------- 
        | mgmt0     | `a4:bf:01:65:6a:aa` | `--mac-mgmt0=a4:bf:01:65:6a:aa`
        | mgmt1     | `a4:bf:01:65:6a:ab` | `--mac-mgmt1=a4:bf:01:65:6a:ab`
        | lan0      | `b8:59:9f:d9:9d:e8` | `--mac-lan0=b8:59:9f:d9:9d:e8`
        | lan1      | `b8:59:9f:d9:9d:e9` | `--mac-lan1=b8:59:9f:d9:9d:e9`
        | hsn0      | `50:6b:4b:23:9f:7c` | `--mac-hsn0=50:6b:4b:23:9f:7c`

        - Otherwise the MACs for the NCN needs to be collected from the NCN using [this procedure](TODO)
          

    4.  Collect the BMC MAC Address.
        -   If the NCN was previously in the system recall the record BMC MAC Address.
        -   If the BMC is reachable by IP, then ipmitool can be used to determine the MAC Address of the BMC:

            For HPE and Gigabyte BMCs:
            ```bash
            ncn-m# export LAN=1
            ```
           
            For Intel BMCs:
            ```bash
            ncn-m# export LAN=3
            ```

            Query the BMC to determine its MAC Address:
            ```bash
            ncn-m# export USERNAME=root
            ncn-m# export IPMI_PASSWORD=changeme
            ncn-m# ipmitool -I lanplus -U $USERNAME -E -H ${NODE}-mgmt lan print $LAN | grep "MAC Address"
            ```
        - Alternatively view the MAC Address table on the management switch the BMC is cabled to. TODO
  
2. Perform a dry run of the `add_management_ncn.py` script to determine if any validation failures occur:
   > Need an explanation of the CLI args
    ```
    ncn-m# ./add_management_ncn.py \
        --xname $XNAME \
        --alias $NODE \
        --bmc-mgmt-switch-connector x3000c0w22j40 \
        --mac-hsn0 50:6b:4b:23:9f:7c \
        --mac-mgmt0 a4:bf:01:65:6a:aa \
        --mac-mgmt1 a4:bf:01:65:6a:ab \
        --mac-lan0 b8:59:9f:d9:9d:e8 \
        --mac-lan1 b8:59:9f:d9:9d:e9 \
        --mac-bmc TODO \
        --dry-run
    ```

3.  Run the `add_management_ncn.py` script to add the NCN to SLS, HSM and BSS:
    > TODO Use environment variables for xname and alias
    ```bash
    ncn-m# ./add_management_ncn.py \
        --xname $XNAME \
        --alias $NODE \
        --bmc-mgmt-switch-connector x3000c0w22j40 \
        --mac-hsn0 50:6b:4b:23:9f:7c \
        --mac-mgmt0 a4:bf:01:65:6a:aa \
        --mac-mgmt1 a4:bf:01:65:6a:ab \
        --mac-lan0 b8:59:9f:d9:9d:e8 \
        --mac-lan1 b8:59:9f:d9:9d:e9 \
        --mac-bmc TODO
    ```


4.  TODO wording get the BMC to its assigned address
    ```
             BMC MAC address exists in HSM Ethernet Interfaces: {'ID': 'a4bf015aad36', 'Description': '', 'MACAddress': 'a4:bf:01:5a:ad:36', 'LastUpdate': '2022-03-09T22:24:18.716112Z', 'ComponentID': '', 'Type': '', 'IPAddresses': [{'IPAddress': '10.254.1.26'}]}

             ipmitool -U root -I lanplus -P initial0 -H 10.254.1.26 mc reset cold

             ping $NODE-mgmt
    ```

4.  Restart REDS:
    ```
    ncn-m001:~/rsjostrand # kubectl -n services rollout restart deployment cray-reds
    deployment.apps/cray-reds restarted
    ncn-m001:~/rsjostrand # kubectl -n services rollout status  deployment cray-reds
    Waiting for deployment "cray-reds" rollout to finish: 1 old replicas are pending termination...
    Waiting for deployment "cray-reds" rollout to finish: 1 old replicas are pending termination...
    deployment "cray-reds" successfully rolled out
    ```

5.  Wait for the NCN BMC to get discovered by HSM:
    ```bash
    ncn-m# export BMC_XNAME=x3000c0s38b0
    ncn-m# watch -n 0.2 "cray hsm inventory redfishEndpoints describe $BMC_XNAME --format json" 
    ```

    Wait until the LastDiscoveryAttempt field is DiscoverOK:
    ```json
    {
        "ID": "x3000c0s38b0",
        "Type": "NodeBMC",
        "Hostname": "",
        "Domain": "",
        "FQDN": "x3000c0s38b0",
        "Enabled": true,
        "UUID": "cc48551e-ec22-4bef-b8a3-bb3261749a0d",
        "User": "root",
        "Password": "",
        "RediscoverOnUpdate": true,
        "DiscoveryInfo": {
            "LastDiscoveryAttempt": "2022-02-28T22:54:08.496898Z",
            "LastDiscoveryStatus": "DiscoverOK",
            "RedfishVersion": "1.7.0"
        }
    }
    ```
    The RedfishEndpoint may cycle between DiscoveryStarted and HTTPsGetFailed before the endpoint becomes DiscoverOK. If the BMC is in HTTPSGetFailed for a long period of time verify the following to help determine the cause:
    - BMC is reachable at the expected IP address.
    - Credentials are correct

6.  Verify the NCN IPs are populated in HSM EthernetInterfaces using the mgmt0 MAC Address.    It may take a few minutes for the IP address information to get populated via KEA.

    ```bash
    ncn-m# export MGMT0_MAC="98:03:9b:bb:a9:94"
    ncn-m# cray hsm inventory ethernetInterfaces list --mac-address $MGMT0_MAC --format json
    ```

    ```json
    [
        {
            "ID": "98039bbba994",
            "Description": "",
            "MACAddress": "98:03:9b:bb:a9:94",
            "LastUpdate": "2022-03-09T23:17:18.262772Z",
            "ComponentID": "x3000c0s7b0n0",
            "Type": "Node",
            "IPAddresses": [
                {
                    "IPAddress": "10.252.1.11"
                }
            ]
        }
    ]
    ```

    <!-- This is for CSM 1.2, where KEA updates HSM-->
    <!-- The following is an example of the mgmt0 MAC Address with no IP addresses populated:
    ```json
    [
        {
            "ID": "a4bf01656aaa",
            "Description": "- kea",
            "MACAddress": "a4:bf:01:65:6a:aa",
            "LastUpdate": "2022-02-28T22:48:52.235379Z",
            "ComponentID": "x3000c0s38b0n0",
            "Type": "Node",
            "IPAddresses": []
        }
    ]
    ```

    The following is an example of the mgmt0 MAC Address with IP addresses populated by KEA:
    ```json
    [
        {
            "ID": "a4bf01656aaa",
            "Description": "- kea",
            "MACAddress": "a4:bf:01:65:6a:aa",
            "LastUpdate": "2022-02-28T22:48:52.235379Z",
            "ComponentID": "x3000c0s38b0n0",
            "Type": "Node",
            "IPAddresses": [
                {
                    "IPAddress": "10.252.1.12"
                },
                {
                    "IPAddress": "10.101.5.141"
                },
                {
                    "IPAddress": "10.254.1.20"
                },
                {
                    "IPAddress": "10.1.1.10"
                }
            ]
        }
    ]
    ``` -->

