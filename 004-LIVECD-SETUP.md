# LiveCD

This page will assist you with configuring and activating your booted LiveCD.

>**`IMPORTANT`** If you've arrived here with files from [002 LiveCD Creation](002-LIVECD-CREATION.md) then you can skip to [Set hostname](#set-hostname)
>**`IMPORTANT`** If you've arrived here with **without** files from [002 LiveCD Creation](002-LIVECD-CREATION.md), you may proceed using the **`MANUAL`** annotated steps. Otherwise you may go back to page [002 LiveCD Creation](002-LIVECD-CREATION.md) and see "Configuration Payload" after setting up your [site-link](#setup-the-site-link-connections).

### LiveCD Interfaces

> **`SKIP IF`** you pre-populated your LiveCD with the steps in [LiveCD Creation](002-LIVECD-CREATION.md).
> Move onto **[Set Hostname](#set-hostname)**.

> Set up variables for lan0 configuration

```bash
pit:~ # site_ip=172.30.XXX.YYY/20
pit:~ # site_gw=172.30.48.1
pit:~ # site_dns=172.30.84.40
pit:~ # site_nic=p1p2
```

- `site_nic` The interface that is directly attached to the site network on ncn-m001.  This should not be lan0.
- `site_ip` The IP address and netmask in CIDR notation that is assigned to the site connection on ncn-m001.  NOTE:  This is NOT just the network, but also the IP address.
- `site_gw` The gateway address for the site network.  This will be used to set up the default gateway route on ncn-m001.
- `site_dns` ONE of the site DNS servers.   The script does not currently handle setting more than one IP address here.

#### Setup the Site-Link Connection(s)

External, direct access.

> **`PREFERRED`** use the generated files from your system inputs...
```bash
pit:~ # system_name=bigbird
pit:~ # cp /var/www/ephemeral/prep/${system_name}/cpt-files/ /etc/sysconfig/network/
pit:~ # wicked ifreload lan0
pit:~ # /root/bin/csi-set-hostname.sh
```

> **`MANUAL`** without CPT files generated by CSI...
```bash
pit:~ # /root/bin/csi-setup-lan0.sh $site_ip $site_gw $site_dns $site_nic
pit:~ # /root/bin/csi-set-hostname.sh
```

If there's an IP showing for `ip a s lan0` then you could exit your CONSOLE and return with an SSH connection (if you prefer).

#### Setup Internal Connections

Now reload the other configurations:

> **`PREFERRED`** use the generated files from your system inputs...

```bash
pit:~ # wicked ifreload all
```

> **`MANUAL`** without CPT files generated by CSI...
```bash
pit:~ # /root/bin/csi-setup-vlan002.sh $nmn_cidr
pit:~ # /root/bin/csi-setup-vlan004.sh $hmn_cidr
pit:~ # /root/bin/csi-setup-vlan007.sh $can_cidr
```
### Set Hostname

This will set the hostname if you did not do it in a previous section.

```
pit:~ # /root/bin/csi-set-hostname.sh
```
### Mount the PITDATA partition

In the latest PIT ISO the `LABEL=PITDATA /var/www/ephemeral` directory no longer mounts automatically.

Manually mount and verify `PITDATA` with

```bash
mount -L PITDATA
lsblk
ls -lh /var/www/ephemeral
```

### Validate the LiveCD platform.

Check that IPs are set for each interface:

```bash
pit:~ # csi pit validate --network
```

### LiveCD Services

> **`SKIP IF`** you pre-populated your LiveCD with the steps in [LiveCD Creation](002-LIVECD-CREATION.md).
> Move onto **[Configure NTP](#configure-ntp)**.

Copy the config files generated earlier by `csi config init` into /etc/dnsmasq.d and /etc/conman.conf.

```bash
cp /var/www/ephemeral/prep/${system_name}/dnsmasq.d/* /etc/dnsmasq.d
cp /var/www/ephemeral/prep/${system_name}/conman.conf /etc/conman.conf
cp /var/www/ephemeral/prep/${system_name}/basecamp/* /var/www/ephemeral/configs/
systemctl restart conman
systemctl restart dnsmasq
systemctl start basecamp
systemctl start nexus
```

### Configure NTP

Start and configure NTP on the LiveCD for a fallback/recovery server:

```bash
pit:~ # /root/bin/configure-ntp.sh
```

### Validate the LiveCD Services

Now verify service health:
- dnsmasq, basecamp, and nexus should report HEALTHY and running.
- No podman container(s) should be dead.

```bash
csi pit validate --services
```

> - If basecamp is dead, restart it with `systemctl restart basecamp`.
> - If dnsmasq is dead, restart it with `systemctl restart dnsmasq`.
> - If nexus is dead, restart it with `systemctl restart nexus`.

You should see two containers: nexus and basecamp

```
CONTAINER ID  IMAGE                                         COMMAND               CREATED     STATUS         PORTS   NAMES
496a2ce806d8  dtr.dev.cray.com/metal/cloud-basecamp:latest                        4 days ago  Up 4 days ago          basecamp
6fcdf2bfb58f  docker.io/sonatype/nexus3:3.25.0              sh -c ${SONATYPE_...  4 days ago  Up 4 days ago          nexus
```

### Verify Outside Name Resolution

> **`SKIP IF AIRGAP/OFFLINE`** - offline installs should skip this check entirely.

Verify you can ping quad9, or Google's, or your IT/site's DNS servers:

```bash
ping 9.9.9.9
ping 8.8.8.8
```

Now is a good time to also verify your local site docker registry, and RPM repository connectivity as well.

> **`INTERNAL USE`** These URLs are important for internal testing and have no use when used outside of CRAY-HPE Labs. This is just provided as an example of relevant endpoints.

You should be able to resolve outside services like arti.dev.cray.com.

```bash
# Artifactory (both are used; one is in the works of replacing the other)
ping arti.dev.cray.com
ping car.dev.cray.com

# Docker Registry
ping dtr.dev.cray.com
```

### Set BMCs to DHCP

If you are reinstalling a system (otherise skip to [Next: Deploy the NCNs](#next-deploy-the-ncns), the BMCs for the NCNs may be set to static.  We check `/var/lib/misc/dnsmasq.leases` for setting up the symlinks for the artifacts each node needs to boot.  So if your BMCs are set to static, those artifacts will not get setup correctly.  You can set them back to DHCP by using a command as such:

```bash
for h in $( grep mgmt /etc/dnsmasq.d/statics.conf | grep -v m001 | awk -F ',' '{print $2}' )
do
ipmitool -U username -I lanplus -H $h -P password lan set 1 ipsrc dhcp
done
```

Some BMCs need a cold reset in order to fully pick up this change:

```bash
for h in $( grep mgmt /etc/dnsmasq.d/statics.conf | grep -v m001 | awk -F ',' '{print $2}' )
do
ipmitool -U username -I lanplus -H $h -P password mc reset cold
done
```

### Next: Deploy the NCNs

Now you can now pass GO, collect $200, and begin the [NCN Boots](005-NCN-BOOTS.md) page...
