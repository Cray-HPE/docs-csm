# SHASTA-CFG

SHASTA-CFG is a distinct repository of relatively static, installation-centric
artifacts, including:

*   Cluster-wide network configuration settings required by Helm Charts
    deployed by product stream Loftsman Manifests
*   [Sealed Secrets](https://github.com/bitnami-labs/sealed-secrets)
*   Sealed Secret Generate Blocks -- an form of plain-text input that renders
    to a Sealed Secret
*   Helm Chart value overrides that are merged into Loftsman Manifests by
    product stream installers

For customers that have an existing SHASTA-CFG repository, you'll need to
update it based on the `shasta-cfg` directory included with a CSM release. If
you've previously updated your SHASTA-CFG repository **for the version of CSM
you are installing**, no further action is required.

> **`NOTE`** The `yq` tool used in the following procedures is available under
> `/mnt/pitdata/prep/site-init/utils/bin` once the SHASTA-CFG repo has been cloned:
>
> ```bash
> linux# alias yq="/mnt/pitdata/prep/site-init/utils/bin/$(uname | awk '{print tolower($0)}')/yq"
> ```


## Create or Update Site-Init Directory

1.  For a system/administrator with an existing SHASTA-CFG repository, clone it
    into `/mnt/pitdata/prep/site-init` as shown below.

    ```bash
    linux# git clone https://stash.us.cray.com/scm/shasta-cfg/<system_name>.git /mnt/pitdata/prep/site-init
    ```

    Otherwise, create `/mnt/pitdata/prep/site-init`:

    ```bash
    linux# mkdir -p /mnt/pitdata/prep/site-init
    ```

2.  **`IMPORTANT`** In order to retain `cray_reds_credentials`,
    `cray_meds_credentials`, or `cray_hms_rts_credentials` credentials already
    in `/mnt/pitdata/prep/site-init/customizations.yaml`, presumably from a
    previous install, they **MUST BE REMOVED** from the
    `spec.kubernetes.tracked_sealed_secrets` list in
    `/mnt/pitdata/${CSM_RELEASE}/shasta-cfg/customizations.yaml`.

    View currently tracked sealed secrets (i.e., those which will be
    re-generated) via:

    ```bash
    linux# yq read /mnt/pitdata/${CSM_RELEASE}/shasta-cfg/customizations.yaml spec.kubernetes.tracked_sealed_secrets
    - cray_reds_credentials
    - cray_meds_credentials
    - cray_hms_rts_credentials
    ```

    To retain e.g. `cray_reds_credentials` already in
    `/mnt/pitdata/prep/site-init/customizations.yaml`:

    ```bash
    linux# yq delete -i /mnt/pitdata/${CSM_RELEASE}/shasta-cfg/customizations.yaml spec.kubernetes.tracked_sealed_secrets.cray_reds_credentials
    ```

    > To retain the REDS/MEDS/RTS credentials the following can be ran:
    > ```
    > yq delete -i /mnt/pitdata/${CSM_RELEASE}/shasta-cfg/customizations.yaml spec.kubernetes.tracked_sealed_secrets.cray_reds_credentials
    > yq delete -i /mnt/pitdata/${CSM_RELEASE}/shasta-cfg/customizations.yaml spec.kubernetes.tracked_sealed_secrets.cray_meds_credentials
    > yq delete -i /mnt/pitdata/${CSM_RELEASE}/shasta-cfg/customizations.yaml spec.kubernetes.tracked_sealed_secrets.cray_hms_rts_credentials
    > ```

3.  Initialize (or update) `/mnt/pitdata/prep/site-init` from CSM:

    ```bash
    linux# /mnt/pitdata/${CSM_RELEASE}/shasta-cfg/meta/init.sh /mnt/pitdata/prep/site-init
    ```


## Update System Customizations

The following steps update `/mnt/pitdata/prep/site-init/customizations.yaml`
with system-specific customizations.

1.  Ensure system-specific settings generated by CSI are merged into
    `customizations.yaml`:

    > Note the system name environment variable `SYSTEM_NAME` must be set 

    ```bash
    linux# yq merge -xP -i /mnt/pitdata/prep/site-init/customizations.yaml <(yq prefix -P "/mnt/pitdata/prep/${SYSTEM_NAME}/customizations.yaml" spec)
    ```

    Set the cluster name:

    ```bash
    linux# yq w -i /mnt/pitdata/prep/site-init/customizations.yaml spec.wlm.cluster_name "$SYSTEM_NAME"
    ```

2.  Review the `spec.kubernetes.sealed_secrets` generate blocks for
    `cray_reds_credentials`, `cray_meds_credentials`, and
    `cray_hms_rts_credentials`. Replace the `Password` references with values
    appropriate for your system. If you opted to keep these secrets, you can
    safely skip this instruction.

3.  To customize the PKI Certificate Authority (CA) used by the platform, see
    [Customizing the Platform CA](055-CERTIFICATE-AUTHORITY.md). 

    > **`IMPORTANT`** The CA may not be modified after install.

4.  To federate Keycloak with an upstream LDAP:

    *   If LDAP requires TLS (recommended), update the `cray-keycloak` sealed
        secret value by supplying a base64 encoded form of your CA
        certificate(s). Admins can use the `keytool` command and a PEM-encoded
        form of your certificate(s) to obtain this value, as follows:

        > **`NOTE`** `keytool` may not be available on the pit server.

        ```bash
        linux# keytool -importcert -trustcacerts -file myad-pub-cert.pem -alias myad -keystore certs.jks -storepass password -noprompt
        linux# cat certs.jks | base64
        ```

    *   Update the `keycloak_users_localize` sealed secret with the
        appropriate value for `ldap_connection_url`. 

        For internal HPE systems, use `ldap://172.30.79.134`.

        Set `ldap_connection_url`:

        ```bash
        linux# yq w -i /mnt/pitdata/prep/site-init/customizations.yaml 'spec.kubernetes.sealed_secrets.keycloak_users_localize.generate.data.(args.name==ldap_connection_url).args.value' 'ldap://172.30.79.134'
        ```

        On success, the `keycloak_users_localize` sealed secret should look
        similar to:

        ```bash
        linux# yq r /mnt/pitdata/prep/site-init/customizations.yaml spec.kubernetes.sealed_secrets.keycloak_users_localize
        generate:
            name: keycloak-users-localize
            data:
            - type: static
                args:
                name: ldap_connection_url
                value: ldap://172.30.79.134
        ```

    *   Configure the `ldapSearchBase` and `localRoleAssignments` settings for
        the `cray-keycloak-users-localize` chart. 

        For internal HPE systems appropriate settings are:

        ```yaml
        ldapSearchBase: "dc=datacenter,dc=cray,dc=com"
        localRoleAssignments:
            - {"group": "criemp", "role": "admin", "client": "shasta"}
            - {"group": "criemp", "role": "admin", "client": "cray"}
            - {"group": "craydev", "role": "admin", "client": "shasta"}
            - {"group": "craydev", "role": "admin", "client": "cray"}
            - {"group": "shasta_admins", "role": "admin", "client": "shasta"}
            - {"group": "shasta_admins", "role": "admin", "client": "cray"}
            - {"group": "shasta_users", "role": "user", "client": "shasta"}
            - {"group": "shasta_users", "role": "user", "client": "cray"}
        ```

        Set `ldapSearchBase`:

        ```bash
        linux# yq w -i /mnt/pitdata/prep/site-init/customizations.yaml spec.kubernetes.services.cray-keycloak-users-localize.ldapSearchBase 'dc=datacenter,dc=cray,dc=com'
        ```

        Set `localRoleAssignments`:

        ```bash
        linux# cat <<EOF | yq write -i -s - /mnt/pitdata/prep/site-init/customizations.yaml | yq r -  spec.kubernetes.services.cray-keycloak-users-localize
        - command: update
            path: spec.kubernetes.services.cray-keycloak-users-localize.localRoleAssignments
            value:
            - {"group": "criemp", "role": "admin", "client": "shasta"} 
            - {"group": "criemp", "role": "admin", "client": "cray"} 
            - {"group": "craydev", "role": "admin", "client": "shasta"} 
            - {"group": "craydev", "role": "admin", "client": "cray"} 
            - {"group": "shasta_admins", "role": "admin", "client": "shasta"} 
            - {"group": "shasta_admins", "role": "admin", "client": "cray"} 
            - {"group": "shasta_users", "role": "user", "client": "shasta"} 
            - {"group": "shasta_users", "role": "user", "client": "cray"}  
        EOF
        ```

        On success, the `cray-keycloak-users-localize` values should look
        similar to:

        ```bash
        linux# yq r /mnt/pitdata/prep/site-init/customizations.yaml spec.kubernetes.services.cray-keycloak-users-localize
        sealedSecrets:
            - '{{ kubernetes.sealed_secrets.keycloak_users_localize | toYaml }}'
        localRoleAssignments:
            - {"group": "criemp", "role": "admin", "client": "shasta"}
            - {"group": "criemp", "role": "admin", "client": "cray"}
            - {"group": "craydev", "role": "admin", "client": "shasta"}
            - {"group": "craydev", "role": "admin", "client": "cray"}
            - {"group": "shasta_admins", "role": "admin", "client": "shasta"}
            - {"group": "shasta_admins", "role": "admin", "client": "cray"}
            - {"group": "shasta_users", "role": "user", "client": "shasta"}
            - {"group": "shasta_users", "role": "user", "client": "cray"}
        ldapSearchBase: dc=datacenter,dc=cray,dc=com
        ```

4.  Review `/mnt/pitdata/prep/site-init/customizations.yaml` and replace
    remaining `~FIXME~` values with appropriate settings.

5.  Re-encrypt secrets in `customizations.yaml`:

    ```bash
    linux:~ # /mnt/pitdata/prep/site-init/utils/secrets-reencrypt.sh /mnt/pitdata/prep/site-init/customizations.yaml /mnt/pitdata/prep/site-init/certs/sealed_secrets.key /mnt/pitdata/prep/site-init/certs/sealed_secrets.crt
    linux:~ # /mnt/pitdata/prep/site-init/utils/secrets-seed-customizations.sh /mnt/pitdata/prep/site-init/customizations.yaml
    Creating Sealed Secret keycloak-certs
    Generating type static_b64...
    Creating Sealed Secret keycloak-master-admin-auth
    Generating type static...
    Generating type static...
    Generating type randstr...
    Generating type static...
    Creating Sealed Secret cray_reds_credentials
    Generating type static...
    Generating type static...
    Creating Sealed Secret cray_meds_credentials
    Generating type static...
    Creating Sealed Secret cray_hms_rts_credentials
    Generating type static...
    Generating type static...
    Creating Sealed Secret vcs-user-credentials
    Generating type randstr...
    Generating type static...
    Creating Sealed Secret generated-platform-ca-1
    Generating type platform_ca...
    Creating Sealed Secret pals-config
    Generating type zmq_curve...
    Generating type zmq_curve...
    Creating Sealed Secret munge-secret
    Generating type randstr...
    Creating Sealed Secret slurmdb-secret
    Generating type static...
    Generating type static...
    Generating type randstr...
    Generating type randstr...
    Creating Sealed Secret keycloak-users-localize
    Generating type static...
    ```

## Commit Site-Init Changes

Add and commit changes to `/mnt/pitdata/prep/site-init` files:

```bash
linux# cd /mnt/pitdata/prep/site-init
linux# git add -A
linux# git commit -m "Updated to $(/mnt/pitdata/${CSM_RELEASE}/lib/version.sh)"
```

> **`NOTE`** If production system or operational security is a concern, **store
> your sealed secret key-pair outside of Git in a secure offline system**.

If `/mnt/pitdata/prep/site-init` was cloned from an upstream repository, be
sure to push these commits:

```bash
linux# git push
```

## Decrypting Sealed Secrets for Review

For administrators that would like to decrypt and review previously encrypted
sealed secrets, you can use the `secrets-decrypt.sh` utility in SHASTA-CFG.

Syntax: `secret-decrypt.sh SEALED-SECRET-NAME SEALED-SECRET-PRIVATE-KEY CUSTOMIZATIONS-YAML`

```bash
linux:/mnt/pitdata/prep/site-init# ./utils/secrets-decrypt.sh cray_meds_credentials ./certs/sealed_secrets.key ./customizations.yaml | jq .data.vault_redfish_defaults | sed -e 's/"//g' | base64 -d; echo
{"Username": "root", "Password": "..."}
```

## Accessing the customizations.yaml from within Cluster

The install procedure outlined in 006-CSM-PLATFORM-INSTALL contains a step which places the customizations.yaml in a Kubernetes secret.  Accessing this file will be a necessary step for some of the other Shasta product installers, such as the UAN.  You can view these install settings and optionally pipe to a file from a Kubernetes master or worker NCN with the following command:

```bash
kubectl get secrets -n loftsman site-init -o jsonpath='{.data.customizations\.yaml}' | base64 -d > /tmp/customizations.yaml
```
