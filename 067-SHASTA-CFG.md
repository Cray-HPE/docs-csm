# SHASTA-CFG

SHASTA-CFG is a distinct repository of relatively static, installation-centric
artifacts, including:

*   Cluster-wide network configuration settings required by Helm Charts
    deployed by product stream Loftsman Manifests
*   [Sealed Secrets](https://github.com/bitnami-labs/sealed-secrets)
*   Sealed Secret Generate Blocks -- an form of plain-text input that renders
    to a Sealed Secret
*   Helm Chart value overrides that are merged into Loftsman Manifests by
    product stream installers

For customers that have an existing SHASTA-CFG repository, you'll need to
update it based on the `shasta-cfg` directory included with a CSM release. If
you've previously updated your SHASTA-CFG repository **for the version of CSM
you are installing**, no further action is required.

> **`NOTE`** The `yq` tool used in the following procedures is available under
> `/mnt/pitdata/prep/site-init/utils/bin` once the SHASTA-CFG repo has been cloned:
>
> ```bash
> linux# alias yq="/mnt/pitdata/${CSM_RELEASE}/shasta-cfg/utils/bin/$(uname | awk '{print tolower($0)}')/yq"
> ```


## Create and Initialize Site-Init Directory

1.  Create directory `/mnt/pitdata/prep/site-init`:

    ```bash
    linux# mkdir -p /mnt/pitdata/prep/site-init
    ```

2.  Initialize `/mnt/pitdata/prep/site-init` from CSM:

    ```bash
    linux# /mnt/pitdata/${CSM_RELEASE}/shasta-cfg/meta/init.sh /mnt/pitdata/prep/site-init
    ```


## Create Baseline System Customizations

The following steps update `/mnt/pitdata/prep/site-init/customizations.yaml`
with system-specific customizations.

1.  Ensure system-specific settings generated by CSI are merged into
    `customizations.yaml`:

    > Note the system name environment variable `SYSTEM_NAME` must be set 

    ```bash
    linux# yq merge -xP -i /mnt/pitdata/prep/site-init/customizations.yaml <(yq prefix -P "/mnt/pitdata/prep/${SYSTEM_NAME}/customizations.yaml" spec)
    ```

    Set the cluster name:

    ```bash
    linux# yq write -i /mnt/pitdata/prep/site-init/customizations.yaml spec.wlm.cluster_name "$SYSTEM_NAME"
    ```

2.  Review the configuration to generate these sealed secrets in `customizations.yaml`:

    * `spec.kubernetes.sealed_secrets.cray_reds_credentials`
    * `spec.kubernetes.sealed_secrets.cray_meds_credentials`
    * `spec.kubernetes.sealed_secrets.cray_hms_rts_credentials`

    Replace the `Password` references with values appropriate for your system.

3.  To customize the PKI Certificate Authority (CA) used by the platform, see
    [Customizing the Platform CA](055-CERTIFICATE-AUTHORITY.md). 

    > **`IMPORTANT`** The CA may not be modified after install.

4.  To federate Keycloak with an upstream LDAP:

    *   If LDAP requires TLS (recommended), update the `cray-keycloak` sealed
        secret value by supplying a base64 encoded Java KeyStore (JKS) that
        contains the CA certificate that signed the LDAP server's host key.
        The password for the JKS file must be `password`.
        Admins can use the `keytool` command and a PEM-encoded form of your
        certificate(s) to obtain this value, as follows:

        > **`NOTE`** `keytool` may not be available on the pit server.

        ```bash
        linux# keytool -importcert -trustcacerts -file myad-pub-cert.pem -alias myad -keystore certs.jks -storepass password -noprompt
        linux# cat certs.jks | base64 > certs.jks.b64
        ```

        For internal HPE systems, create the `certs.jks.b64` file by running the following command:

        ```bash
        linux# echo "/u3+7QAAAAIAAAABAAAAAgAHY2FfY2VydAAAAXeRoKKOAAVYLjUwOQAAA8EwggO9MIICpaADAgECAhRjGsb8+sxyYjMO4n5TUaHyGmxTxzANBgkqhkiG9w0BAQsFADBuMQswCQYDVQQGEwJVUzELMAkGA1UECAwCV0kxDDAKBgNVBAoMA0hQRTEQMA4GA1UECwwHSFBDL01DUzEUMBIGA1UEAwwLRGF0YSBDZW50ZXIxHDAaBgkqhkiG9w0BCQEWDWRjb3BzQGhwZS5jb20wHhcNMjAxMTI0MjAzMzQxWhcNMzAxMTIyMjAzMzQxWjBuMQswCQYDVQQGEwJVUzELMAkGA1UECAwCV0kxDDAKBgNVBAoMA0hQRTEQMA4GA1UECwwHSFBDL01DUzEUMBIGA1UEAwwLRGF0YSBDZW50ZXIxHDAaBgkqhkiG9w0BCQEWDWRjb3BzQGhwZS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC4EhmQqK0cdVAfKa1pC3gPxmEbio0nRxOwuE4M8y1W0GM9mnn1749bNtz1GPn7B+Msa14rr980mwly1aVL9qviPD/EEg8yTmmDR2eQxPazuWRIKbJ31SJvu7rLoTzJ4agZxvsj7hkj4TcVBXvM9py3pvXvGZqM3IqvOEEYSNi5xglQvmJOBnprsc5lTY5pBJd7ty2IcHF7untGEcK4pGuomfGiiFqSWgrCAcfMMsVDNf/kAOnWF0lx25alpdhEwG7pvWaGbCjm+Zz58Od9SmXn9fiLXT2v1U3skLsNDn4lfy71IcMYuCAFaSuGm+Vs1cxUKfCdIV9v+ueYY7ut0lKnAgMBAAGjUzBRMB0GA1UdDgQWBBRWDdVgTFQB2fZYTd7xdzwc43L/7jAfBgNVHSMEGDAWgBRWDdVgTFQB2fZYTd7xdzwc43L/7jAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQBYsNAsHquuYr6DBRj7gHvRRJtArQmQta5zS0J+NPE1BPMVvvk94f4YfbVCyNQjxULpA4AAni7MgRXzlWk5A+mqPP4sj8SPXFd/Pmiy1lC72sIyc+1W7slPQH41Xse+CqJ1N9rYzZ3D3JRhLay6tk7xLQOrcGLogSG0ZTdPxmlsCYCn6c2xolZ1Q2MPgQI7msCTID9W75bIzPoXdkMGZGuKlYzUHXq/HytKlCnKBj4U1fh7VGqyUqGjK7Nd9QbPJe7HnKGz+585qo5ELDeskjG/ixNYaxIEtcOwUzeUGCWNIAd+YO4p075C/sSobMJEymBJyJmKGdtChGs9mQ4dTGs0M64IiKAYKQ31wT+5DJimXB1olmw=" > certs.jks.b64
        ```

        Once you've got the `certs.jks.b64` file, inject and encrypt the file
        into the `customizations.yaml` file using the following command:

        ```bash
        linux# cat <<EOF | yq w - 'data."certs.jks"' "$(<certs.jks.b64)" |
          yq r -j - | /mnt/pitdata/prep/site-init/utils/secrets-encrypt.sh |
          yq w -f - -i /mnt/pitdata/prep/site-init/customizations.yaml 'spec.kubernetes.sealed_secrets.cray-keycloak'
        {
          "kind": "Secret",
          "apiVersion": "v1",
          "metadata": {
            "name": "keycloak-certs",
            "namespace": "services",
            "creationTimestamp": null
          },
          "data": {}
        }
        EOF
        ```

    *   Update the `keycloak_users_localize` sealed secret with the
        appropriate value for `ldap_connection_url`. 

        For internal HPE systems, if the IP address for the ncn-m001 node is
        even then use `ldaps://dcldap2.us.cray.com`, otherwise use
        `ldaps://dcldap3.us.cray.com`. For example,
        `ping fanta-ncn-m001.us.cray.com` shows the IP address is
        `172.30.52.72`, so fanta would use `ldaps://dcldap2.us.cray.com` as the
        `ldap_connection_url`. This just spreads the load over the 2 LDAP
        replicas.

        Set `ldap_connection_url`:

        ```bash
        linux# yq write -i /mnt/pitdata/prep/site-init/customizations.yaml 'spec.kubernetes.sealed_secrets.keycloak_users_localize.generate.data.(args.name==ldap_connection_url).args.value' 'ldaps://dcldap2.us.cray.com'
        ```

        On success, the `keycloak_users_localize` sealed secret should look
        similar to:

        ```bash
        linux# yq read /mnt/pitdata/prep/site-init/customizations.yaml spec.kubernetes.sealed_secrets.keycloak_users_localize
        generate:
            name: keycloak-users-localize
            data:
            - type: static
                args:
                name: ldap_connection_url
                value: ldaps://dcldap3.us.cray.com
        ```

    *   Configure the `ldapSearchBase` and `localRoleAssignments` settings for
        the `cray-keycloak-users-localize` chart. 

        For internal HPE systems appropriate settings are:

        ```yaml
        ldapSearchBase: "dc=dcldap,dc=dit"
        localRoleAssignments:
            - {"group": "criemp", "role": "admin", "client": "shasta"}
            - {"group": "criemp", "role": "admin", "client": "cray"}
            - {"group": "craydev", "role": "admin", "client": "shasta"}
            - {"group": "craydev", "role": "admin", "client": "cray"}
            - {"group": "shasta_admins", "role": "admin", "client": "shasta"}
            - {"group": "shasta_admins", "role": "admin", "client": "cray"}
            - {"group": "shasta_users", "role": "user", "client": "shasta"}
            - {"group": "shasta_users", "role": "user", "client": "cray"}
        ```

        Set `ldapSearchBase`:

        ```bash
        linux# yq write -i /mnt/pitdata/prep/site-init/customizations.yaml spec.kubernetes.services.cray-keycloak-users-localize.ldapSearchBase 'dc=dcldap,dc=dit'
        ```

        Set `localRoleAssignments`:

        ```bash
        linux# yq write -s - -i /mnt/pitdata/prep/site-init/customizations.yaml <<EOF
        - command: update
          path: spec.kubernetes.services.cray-keycloak-users-localize.localRoleAssignments
          value:
          - {"group": "criemp", "role": "admin", "client": "shasta"}
          - {"group": "criemp", "role": "admin", "client": "cray"}
          - {"group": "craydev", "role": "admin", "client": "shasta"}
          - {"group": "craydev", "role": "admin", "client": "cray"}
          - {"group": "shasta_admins", "role": "admin", "client": "shasta"}
          - {"group": "shasta_admins", "role": "admin", "client": "cray"}
          - {"group": "shasta_users", "role": "user", "client": "shasta"}
          - {"group": "shasta_users", "role": "user", "client": "cray"}
        EOF
        ```

        On success, the `cray-keycloak-users-localize` values should look
        similar to:

        ```bash
        linux# yq read /mnt/pitdata/prep/site-init/customizations.yaml spec.kubernetes.services.cray-keycloak-users-localize
        sealedSecrets:
            - '{{ kubernetes.sealed_secrets.keycloak_users_localize | toYaml }}'
        localRoleAssignments:
            - {"group": "criemp", "role": "admin", "client": "shasta"}
            - {"group": "criemp", "role": "admin", "client": "cray"}
            - {"group": "craydev", "role": "admin", "client": "shasta"}
            - {"group": "craydev", "role": "admin", "client": "cray"}
            - {"group": "shasta_admins", "role": "admin", "client": "shasta"}
            - {"group": "shasta_admins", "role": "admin", "client": "cray"}
            - {"group": "shasta_users", "role": "user", "client": "shasta"}
            - {"group": "shasta_users", "role": "user", "client": "cray"}
        ldapSearchBase: dc=dcldap,dc=dit
        ```

5.  If you need to resolve outside hostnames, you will need to configure forwarding in the cray-dns-unbound service.
    For example, if you are using a hostname and not an IP for the upstream LDAP server in step 4 above, you will need to be able to resolve that hostname.

    Set the `localZones` and `forwardZones` for the `cray-dns-unbound` service:

    ```bash
    linux# yq write -s - -i /mnt/pitdata/prep/site-init/customizations.yaml <<EOF
    - command: update
      path: spec.kubernetes.services.cray-dns-unbound
      value:
        localZones:
        - localType: static
          name: "local"
        forwardZones:
        - name: "."
          forwardIps:
          - "{{ network.netstaticips.system_to_site_lookups }}"
    EOF
    ```

6.  Review `customizations.yaml` and replace remaining `~FIXME~` values with
    appropriate settings.

    For the following `~FIXME~` values, use the example provided and just remove the `~FIXME~ e.g.`

     ```bash
        sma-rsyslog-aggregator:
          cray-service:
            service:
              loadBalancerIP: ~FIXME~ e.g. 10.92.100.72
          rsyslogAggregatorHmn:
            service:
              loadBalancerIP: ~FIXME~ e.g. 10.94.100.2

        sma-rsyslog-aggregator-udp:
          cray-service:
            service:
              loadBalancerIP: ~FIXME~ e.g. 10.92.100.75
          rsyslogAggregatorUdpHmn:
            service:
              loadBalancerIP: ~FIXME~ e.g. 10.94.100.3
     ```

7.  Load container images required by Sealed Secret Generators

    If running through this process on a Shasta 1.3 ncn-m001 node, or a node (laptop, ...) external to Shasta, run:

    ```bash
    linux:~ # /mnt/pitdata/${CSM_RELEASE}/csm/hack/load-container-image.sh dtr.dev.cray.com/zeromq/zeromq:v4.0.5
    ```

    If running through this process on a Shasta 1.4 ncn-m001 node (after reboot of the LiveCD and ncn-m001 has joined the K8S Cluster), run:

    ```bash
    linux:~ # podman pull registry.local/zeromq/zeromq:v4.0.5
    linux:~ # podman tag registry.local/zeromq/zeromq:v4.0.5 dtr.dev.cray.com/zeromq/zeromq:v4.0.5
    ```

    > Note: you must properly configured Docker or Podman environment.

8.  Re-encrypt and seed secrets in `customizations.yaml`:

    ```bash
    linux# /mnt/pitdata/prep/site-init/utils/secrets-reencrypt.sh /mnt/pitdata/prep/site-init/customizations.yaml /mnt/pitdata/prep/site-init/certs/sealed_secrets.key /mnt/pitdata/prep/site-init/certs/sealed_secrets.crt
    linux# /mnt/pitdata/prep/site-init/utils/secrets-seed-customizations.sh /mnt/pitdata/prep/site-init/customizations.yaml
    Creating Sealed Secret keycloak-certs
    Generating type static_b64...
    Creating Sealed Secret keycloak-master-admin-auth
    Generating type static...
    Generating type static...
    Generating type randstr...
    Generating type static...
    Creating Sealed Secret cray_reds_credentials
    Generating type static...
    Generating type static...
    Creating Sealed Secret cray_meds_credentials
    Generating type static...
    Creating Sealed Secret cray_hms_rts_credentials
    Generating type static...
    Generating type static...
    Creating Sealed Secret vcs-user-credentials
    Generating type randstr...
    Generating type static...
    Creating Sealed Secret generated-platform-ca-1
    Generating type platform_ca...
    Creating Sealed Secret pals-config
    Generating type zmq_curve...
    Generating type zmq_curve...
    Creating Sealed Secret munge-secret
    Generating type randstr...
    Creating Sealed Secret slurmdb-secret
    Generating type static...
    Generating type static...
    Generating type randstr...
    Generating type randstr...
    Creating Sealed Secret keycloak-users-localize
    Generating type static...
    ```

## Version Control Site-Init Files

Setup `/mnt/pitdata/prep/site-init` as a Git repository in order to manage the
baseline configuration during initial system installation.

1.  Initialize `/mnt/pitdata/prep/site-info` as a Git repository:

    ```bash
    linux# cd /mnt/pitdata/prep/site-init
    linux# git init .
    ```

2.  (Optional) **`WARNING`** If production system or operational security is a
    concern, do NOT store the sealed secret private key in Git; instead,
    **store the sealed secret key outside of Git in a secure offline system**.
    To ensure these sensitive keys are not accidentally committed, configure
    `.gitignore` to ignore files under the `certs` directory:

    ```bash
    linux# echo "certs/" >> .gitignore
    ```

3.  Stage site-init files to be committed:

    ```bash
    linux# git add -A
    ```

4.  Review what will be committed:

    ```bash
    linux# git status
    ```

5.  Commit all the above changes as the baseline configuration:

    ```bash
    linux# git commit -m "Baseline configuration for $(/mnt/pitdata/${CSM_RELEASE}/lib/version.sh)"
    ```


### Push to a Remote Repository

It is **strongly recommended** to that the site-init repository be maintained
off-cluster. Add a remote repository and push the baseline configuration on
`master` branch to a corresponding remote branch. 


## Customer-Specific Customizations

Customer-specific customizations are any changes on top of the baseline
configuration to satisfy customer-specific requirements. It is recommended that
customer-specific customizations be tracked on branches separate from the
mainline in order to make them easier to manage.

Apply any customer-specific customizations by merging the corresponding
branches into `master` branch of `/mnt/pitdata/prep/site-init`.

When considering merges, and especially when resolving conflicts, carefully
examine differences to ensure all changes are relevant. For example, when
applying a customer-specific customization used in a prior version, be sure the
change still makes sense. It’s common for options to change as new features are
introduced and bugs are fixed.


----


## Tracked Sealed Secrets

Tracked sealed secrets are regenerated everytime secrets are seeded (see the
use of `utils/secrets-seed-customizations.sh` above). View currently tracked
sealed secrets via:

```bash
linux# yq read /mnt/pitdata/${CSM_RELEASE}/shasta-cfg/customizations.yaml spec.kubernetes.tracked_sealed_secrets
- cray_reds_credentials
- cray_meds_credentials
- cray_hms_rts_credentials
```

In order to prevent tracked sealed secrets from being regenerated, they **MUST
BE REMOVED** from the `spec.kubernetes.tracked_sealed_secrets` list in
`/mnt/pitdata/${CSM_RELEASE}/shasta-cfg/customizations.yaml` prior to seeding.
To retain the REDS/MEDS/RTS credentials, run:

```bash
linux# yq delete -i /mnt/pitdata/${CSM_RELEASE}/shasta-cfg/customizations.yaml spec.kubernetes.tracked_sealed_secrets.cray_reds_credentials
linux# yq delete -i /mnt/pitdata/${CSM_RELEASE}/shasta-cfg/customizations.yaml spec.kubernetes.tracked_sealed_secrets.cray_meds_credentials
linux# yq delete -i /mnt/pitdata/${CSM_RELEASE}/shasta-cfg/customizations.yaml spec.kubernetes.tracked_sealed_secrets.cray_hms_rts_credentials
```


## Decrypting Sealed Secrets for Review

For administrators that would like to decrypt and review previously encrypted
sealed secrets, you can use the `secrets-decrypt.sh` utility in SHASTA-CFG.

Syntax: `secret-decrypt.sh SEALED-SECRET-NAME SEALED-SECRET-PRIVATE-KEY CUSTOMIZATIONS-YAML`

```bash
linux:/mnt/pitdata/prep/site-init# ./utils/secrets-decrypt.sh cray_meds_credentials ./certs/sealed_secrets.key ./customizations.yaml | jq .data.vault_redfish_defaults | sed -e 's/"//g' | base64 -d; echo
{"Username": "root", "Password": "..."}
```


## Site-Init Kubernetes Secret

The `site-init` Secret (in the `loftsman` namespace) is created at the
beginning of [the CSM platform install procedures](006-CSM-PLATFORM-INSTALL.md)
and contains `customizations.yaml`. When the pit server is rebooted as ncn-m001
at the end of the CSM install, the `site-init` Secret is the mechanism other
Cray/HPE product installers will use to obtain `customizations.yaml`.

To read `customizations.yaml` from the `site-init` secret:

```bash
# kubectl get secrets -n loftsman site-init -o jsonpath='{.data.customizations\.yaml}' | base64 -d
```


## Modifying Customizations During Installation

If for some reason system customizations need to be modified to complete
product installtion, administrators must first update `customizations.yaml` in
the site-init Git repository, which may no longer be mounted on any cluster
node, and then delete and recreate the `site-init` secret.

To delete the `site-init` secret:

```bash
# kubectl -n loftsman delete secret site-init
```

To recreate the `site-init` secret:

```bash
# kubectl create secret -n loftsman generic site-init --from-file=customizations.yaml
```
